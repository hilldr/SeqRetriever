
#' SeqStudents
#'
#' This function performs a two-tailed Student's t-test on two groups specified by the user. The preferred input is a dataframe generated using SeqDataframe().
#' @param df The dataframe generated by SeqDataframe
#' @param group1 A string unique to the columns in 'data' that contain the first data set to be compared
#' @param group2 A string unique to the columns in 'data' that contain the second data set to be compared
#' @param p.adjust.method Correction method for ANOVA p-value. Accepted options are "holm", "hochberg", "hommel", "bonferroni", "BH", "BY", "fdr", "none". See ?p.adjust for discussion of methods. Default = "bonferroni"
#' @export
#' @examples
#' results <- SeqStudents(SeqDataframe(dir="./norm_out"), group1 = "ES", group2 = "HLO")

SeqStudents <- function(df = df,
                        group1 = "ES",
                        group2 = "HLO",
                        p.adjust.method = "bonferroni"){
    
    ## Define the two sample groups
    get_groups <- function(x){
        o <- intersect(
            grep(x,colnames(df)), 
            grep(".p|Mean.|log2.", colnames(df),invert = TRUE))
        return(o)
    }

    gp1 <- get_groups(group1)
    gp2 <- get_groups(group2)
    
    ## Calculate mean by sample group
    library(matrixStats)
    df[paste("Mean.",group1,sep="")] <- rowMeans(df[,gp1],na.rm=T)
    df[paste("Mean.",group2,sep="")] <- rowMeans(df[,gp2],na.rm=T)
    
    ## Calculate log2 expression 
    df[paste("log2.",group1,".ovr.",group2,sep="")] <- log2(df[paste("Mean.",group1,sep="")]/df[paste("Mean.",group2,sep="")])
    
    ## function to compare by row, returns t distribution
    ## The function is defined as
    row.t <- function(mat1,mat2){
        mat1 <- as.matrix(mat1)
        mat2 <- as.matrix(mat2)
        n1 <- dim(mat1)[2]
        n2 <- dim(mat2)[2] 
        n <- n1+n2 
        m1 <- rowMeans(mat1,na.rm=TRUE) 
        m2 <- rowMeans(mat2,na.rm=TRUE) 
        v1 <- rowVars(mat1,na.rm=TRUE) 
        v2 <- rowVars(mat2,na.rm=TRUE) 
        vpool <- (n1-1)/(n-2)*v1 + (n2-1)/(n-2)*v2 
        tstat <- sqrt(n1*n2/n)*(m1-m2)/sqrt(vpool) 
        return(tstat)
    }
    
    ## calculate t-distribution for group1 vs. group2
    tstat <- row.t(df[,gp1],df[,gp2])
    
    ## calculate degrees of freedom
    degfree <- (length(gp1)+length(gp2))-2
    
    ## express t-dist as two-sided p-value
    df[paste("ttest.",group1,".v.",group2,".p",sep="")] <- 2*pt(-abs(tstat),df=degfree)
    
    ## calculate Bonferroni correction
    df[paste("ttest.",group1,".v.",group2,".p.adj",sep="")] <- p.adjust(2 * pt(-abs(tstat),df = degfree), method = p.adjust.method, n = dim(df)[1])

    return(df)
}
